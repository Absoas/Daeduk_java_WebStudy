<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Prod">
	
	<sql id="searchFrag">
		<dynamic prepend=" WHERE ">
			<isNotNull property="searchVO">
				<isNotEmpty property="searchVO.prod_lgu" prepend="AND">
					PROD_LGU = #searchVO.prod_lgu#
				</isNotEmpty>
				
				<isNotEmpty property="searchVO.prod_buyer" prepend="AND">
					PROD_BUYER = #searchVO.prod_buyer#
				</isNotEmpty>
				
				<isNotEmpty property="searchVO.prod_name" prepend="AND">
					PROD_NAME like '%'||#searchVO.prod_name#||'%'
				</isNotEmpty>
				
			</isNotNull>
		</dynamic>
	</sql>
	
	<select id = "selectTotalRecord" resultClass="Long" parameterClass="pagingVO">
		select count(*) from prod
		<include refid="Prod.searchFrag"/>
	</select>
	
	<select id = "selectProdList" resultClass="prodVO" parameterClass="pagingVO">
		SELECT A.*
		from(
		select ROWNUM RNUM, prod_id,prod_name,prod_price,prod_outline,prod_mileage,
		     lprod_nm , buyer_name
		from prod INNER JOIN lprod on(PROD_LGU = lprod_gu)
		                 INNER JOIN buyer on(prod_buyer = buyer_id)
			<include refid="Prod.searchFrag"/>
		)A
		<![CDATA[
		where RNUM >= #startRow# and RNUM <= #endRow#
		]]>
	</select>
	
	<resultMap class="buyerVO" id="buyerMap">
		<result property="buyer_name" column="BUYER_NAME"/>
		<result property="buyer_add1" column="BUYER_ADD1"/>
		<result property="buyer_charger" column="BUYER_CHARGER"/>
		<result property="buyer_comtel" column="BUYER_COMTEL"/>
	</resultMap>
	
	<resultMap class="memberVO" id="memberMap">
		<result property="mem_id" column="MEM_ID"/>
		<result property="mem_name" column="MEM_NAME"/>
		<result property="mem_add1" column="MEM_ADD1"/>
		<result property="mem_add2" column="MEM_ADD2"/>
		<result property="mem_hp" column="MEM_HP"/>
		<result property="mem_mail" column="MEM_MAIL"/>
	</resultMap>
	
	<resultMap class="prodVO" id="prodMap" groupBy="prod_id">
		<result property = "lprod_nm" column = "LPROD_NM"/>
		<result property = "prod_id" column = "PROD_ID"/>
		<result property = "prod_name" column = "PROD_NAME"/>
		<result property = "prod_lgu" column = "PROD_LGU"/>
		<result property = "prod_buyer" column = "PROD_BUYER"/>
		<result property = "prod_cost" column = "PROD_COST"/>
		<result property = "prod_price" column = "PROD_PRICE"/>
		<result property = "prod_sale" column = "PROD_SALE"/>
		<result property = "prod_outline" column = "PROD_OUTLINE"/>
		<result property = "prod_detail" column = "PROD_DETAIL"/>
		<result property = "prod_img" column = "PROD_IMG"/>
		<result property = "prod_totalstock" column = "PROD_TOTALSTOCK"/>
		<result property = "prod_insdate" column = "PROD_INSDATE"/>
		<result property = "prod_properstock" column = "PROD_PROPERSTOCK"/>
		<result property = "prod_size" column = "PROD_SIZE"/>
		<result property = "prod_color" column = "PROD_COLOR"/>
		<result property = "prod_delivery" column = "PROD_DELIVERY"/>
		
		<result property="buyer" resultMap="Prod.buyerMap" />
		<result property="customers" resultMap="Prod.memberMap" javaType="java.util.List"/> 
	</resultMap>
	
	<select id = "selectProd" parameterClass="String" resultMap="Prod.prodMap"  >
		        SELECT
		    prod_id,prod_name, prod_lgu,
		    prod_buyer,prod_cost, prod_price,
		    prod_sale, prod_outline, prod_detail,
		    prod_img,prod_totalstock, to_char(prod_insdate,'YYYY-MM-DD') prod_insdate,
		    prod_properstock, prod_size, prod_color,
		    prod_delivery,prod_unit,prod_qtyin,
		    prod_qtysale, prod_mileage
		    ,lprod_nm
		    ,buyer_name,buyer_add1, buyer_charger, buyer_comtel
            ,MEM_ID,MEM_NAME,mem_add1,mem_add2,mem_hp,mem_mail
			FROM
		    prod inner join lprod on (prod_lgu = lprod_gu)
		    	 inner join buyer on (prod_buyer = buyer_id)
                 LEFT OUTER JOIN CART ON(PROD_ID = CART_PROD)
                 LEFT OUTER JOIN MEMBER ON(CART_MEMBER = MEM_ID)
		    where prod_id = #prod_id#
	</select>
	
</sqlMap>
